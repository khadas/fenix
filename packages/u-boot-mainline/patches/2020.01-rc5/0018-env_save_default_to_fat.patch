From dc776c2c7054b2ed7b26cdeb3dc4efdf842a6838 Mon Sep 17 00:00:00 2001
From: hyphop <art@khadas.com>
Date: Tue, 10 Mar 2020 23:21:40 +0900
Subject: [PATCH] env_save_default_to_fat

---
 arch/arm/mach-meson/board-common.c | 15 ++++++++++-----
 common/board_r.c                   | 13 ++++++++++++-
 env/fat.c                          | 24 +++++++++++++++---------
 3 files changed, 37 insertions(+), 15 deletions(-)

diff --git a/arch/arm/mach-meson/board-common.c b/arch/arm/mach-meson/board-common.c
index d33e7f17..52a67b61 100644
--- a/arch/arm/mach-meson/board-common.c
+++ b/arch/arm/mach-meson/board-common.c
@@ -23,10 +23,6 @@
 
 DECLARE_GLOBAL_DATA_PTR;
 
-__weak int board_init(void)
-{
-	return 0;
-}
 
 int dram_init(void)
 {
@@ -142,10 +138,19 @@ __weak int meson_board_late_init(void)
 	return 0;
 }
 
-int board_late_init(void)
+__weak int board_init(void)
 {
+	//env init there 
+	env_set_default(NULL, 0);
+	//set env boot_source
 	meson_set_boot_source();
 
+	return 0;
+
+}
+
+int board_late_init(void)
+{
 	return meson_board_late_init();
 }
 
diff --git a/common/board_r.c b/common/board_r.c
index 54641722..3c710754 100644
--- a/common/board_r.c
+++ b/common/board_r.c
@@ -465,7 +465,6 @@ static int initr_env(void)
 
 	/* Initialize from environment */
 	load_addr = env_get_ulong("loadaddr", 16, load_addr);
-
 	return 0;
 }
 
@@ -644,6 +643,16 @@ static int run_main_loop(void)
 	return 0;
 }
 
+static int run_env_save(void)
+{
+    if ( env_get("env_need_save") ){
+	printf("[i] env_need_save... ");
+	env_set("env_need_save",NULL);
+	run_command("saveenv",1);
+    }
+    return 0;
+}
+
 /*
  * We hope to remove most of the driver-related init and do it if/when
  * the driver is later used.
@@ -829,6 +838,7 @@ static init_fnc_t init_sequence_r[] = {
 	 * Interrupts) are up and running (i.e. the PC-style ISA
 	 * keyboard).
 	 */
+
 	last_stage_init,
 #endif
 #ifdef CONFIG_CMD_BEDBUG
@@ -838,6 +848,7 @@ static init_fnc_t init_sequence_r[] = {
 #if defined(CONFIG_PRAM)
 	initr_mem,
 #endif
+	run_env_save,
 	run_main_loop,
 };
 
diff --git a/env/fat.c b/env/fat.c
index 9075147f..6ebcc8ec 100644
--- a/env/fat.c
+++ b/env/fat.c
@@ -110,6 +110,21 @@ static int env_fat_load(void)
 	}
 
 	err = file_fat_read(CONFIG_ENV_FAT_FILE, buf, CONFIG_ENV_SIZE);
+
+#define CONFIG_ENV_FAT_CREATE 1
+
+#ifdef CONFIG_ENV_FAT_CREATE
+//	env_set("env_source", env_get("boot_source"));
+//	printf("env_fat_load error: %d\n", err);
+//	file not found
+	if (err == -2) {
+		printf("\"%s\" not found on %s-%d:%d... ",
+			CONFIG_ENV_FAT_FILE, CONFIG_ENV_FAT_INTERFACE, dev, part );
+	    	env_set("env_need_save", "1");
+		return 0;
+	}
+#endif
+
 	if (err == -1) {
 		/*
 		 * This printf is embedded in the messages from env_save that
 	return env_import(buf, 1);
-- 
2.17.1

